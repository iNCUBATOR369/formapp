<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FormApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#6a6a6a; --primary:#0a84ff; --card:#f5f7fb; --radius:16px }
    [data-theme="dark"] { --bg:#0f1113; --fg:#eee; --muted:#9aa4af; --primary:#39a0ff; --card:#15181b }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;display:grid;place-items:center}
    .card{width:min(720px,92vw);background:var(--card);padding:24px;border-radius:16px;box-shadow:0 8px 28px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;margin-top:12px}
    input{flex:1;padding:12px 14px;border-radius:12px;border:0;outline:none;background:#fff;color:#111;box-shadow:inset 0 0 0 1px rgba(0,0,0,.08)}
    [data-theme="dark"] input{background:#111;color:#eee;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;cursor:pointer;background:var(--primary);color:#fff;font-weight:600;box-shadow:0 6px 18px rgba(10,132,255,.25)}
    .ghost{background:transparent;color:var(--fg);box-shadow:none}
    small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="card">
    <h2>Welcome to FormApp üëã</h2>
    <p>Type any text below and press <b>Send to bot</b>. The bot will publish it in the chat.</p>

    <div class="row">
      <input id="msg" placeholder="This message came from the Mini App!" />
      <button id="send" class="btn">Send to bot</button>
    </div>

    <div class="row">
      <button id="toggle" class="btn ghost">Toggle theme</button>
      <button id="close"  class="btn ghost">Close</button>
    </div>

    <small id="meta"></small>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const unsafe = tg.initDataUnsafe || {};

    // --- —Ç–µ–º–∞
    function applyTheme(theme){
      document.documentElement.dataset.theme = theme;
      if (theme === 'dark') {
        tg.setHeaderColor('#0f1113');
        tg.setBackgroundColor('#0f1113');
      } else {
        tg.setHeaderColor('#ffffff');
        tg.setBackgroundColor('#ffffff');
      }
    }
    applyTheme(tg.colorScheme === 'dark' ? 'dark' : 'light');
    tg.onEvent('themeChanged', () => applyTheme(tg.colorScheme === 'dark' ? 'dark' : 'light'));

    document.getElementById('toggle').addEventListener('click', () => {
      const cur = document.documentElement.dataset.theme || 'light';
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    });

    // –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    document.getElementById('meta').textContent =
      `User: ${unsafe?.user?.username || unsafe?.user?.id || 'n/a'} | ` +
      `Chat: ${unsafe?.chat?.id || 'n/a'} | ` +
      `Query: ${unsafe?.query_id ? 'inline' : 'none'} | ` +
      `Source: ${unsafe?.start_param ? 'start_param' : 'webApp'}`;

    function safeClose() {
      try { tg.close(); } catch(e) {}
      // —Ñ–æ–ª–±—ç–∫ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö close() –≥–ª—é—á–∏—Ç
      setTimeout(() => {
        try { window.close(); } catch(e) {}
        try { history.back(); } catch(e) {}
        // –∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π ‚Äî —É–≤–æ–¥–∏–º —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        try { location.href = 'about:blank'; } catch(e) {}
      }, 120);
    }

    async function sendViaServer(payload) {
      const res = await fetch('/tg', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      return res.json().catch(()=> ({}));
    }

    async function onSend() {
      const text = (document.getElementById('msg').value || '').trim() || 'This message came from the Mini App!';

      // —Ä–µ–∂–∏–º 2: –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞ (–µ—Å—Ç—å query_id) ‚Üí answerWebAppQuery
      if (unsafe?.query_id) {
        await sendViaServer({ text, queryId: unsafe.query_id, initData: tg.initData || '' });
        tg.showAlert('Sent!');
        return safeClose();
      }

      // —Ä–µ–∂–∏–º 3: attach-–ø–∞–Ω–µ–ª—å (¬´Open FormApp¬ª —Å–ø—Ä–∞–≤–∞) ‚Üí sendData
      // –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ chat –≤ initData –æ–±—ã—á–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
      if (!unsafe?.chat) {
        tg.sendData(JSON.stringify({ type:'form', text }));
        tg.showAlert('Sent!');
        return safeClose();
      }

      // —Ä–µ–∂–∏–º 1: –º–µ–Ω—é –±–æ—Ç–∞ ‚Üí –æ–±—ã—á–Ω—ã–π sendMessage
      const recipient = unsafe.chat?.id || unsafe.user?.id;
      await sendViaServer({ text, chatId: recipient, initData: tg.initData || '' });
      tg.showAlert('Sent!');
      return safeClose();
    }

    document.getElementById('send').addEventListener('click', onSend);
    document.getElementById('close').addEventListener('click', safeClose);
  </script>
</body>
</html>
