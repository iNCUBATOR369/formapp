// server.js ‚Äî –≤–µ—Ä—Å–∏—è —Å webhook (–±–µ–∑ bot.launch / getUpdates)
require('dotenv').config();

const express = require('express');
const path = require('path');
const { Telegraf, Markup } = require('telegraf');

const BOT_TOKEN = process.env.BOT_TOKEN;
const PUBLIC_URL = process.env.PUBLIC_URL;

if (!BOT_TOKEN) {
  console.error('‚ùå No BOT_TOKEN in env'); process.exit(1);
}
if (!PUBLIC_URL) {
  console.error('‚ùå No PUBLIC_URL in env'); process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);

// /start ‚Äî –¥–∞—ë–º –∫–Ω–æ–ø–∫—É –¥–ª—è Mini App
bot.start(async (ctx) => {
  await ctx.reply(
    'Welcome! Tap to open üëá',
    Markup.inlineKeyboard([ Markup.button.webApp('Open Mini App (inline)', PUBLIC_URL) ])
  );
});

// –ø—Ä–æ—Å—Ç–æ–π echo –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
bot.on('text', async (ctx) => {
  await ctx.reply(`You said: ${ctx.message.text}`);
});

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, 'public')));

// –æ—Ç–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É Mini App
app.get('/', (_req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// === Webhook ===
// —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—É—Ç—å –≤–µ–±—Ö—É–∫–∞ ‚Äî –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Ç–æ–∫–µ–Ω—É
const WEBHOOK_PATH = `/tg/${BOT_TOKEN}`;
const WEBHOOK_URL  = `${PUBLIC_URL}${WEBHOOK_PATH}`;

// Telegram –±—É–¥–µ—Ç —Å–ª–∞—Ç—å –∞–ø–¥–µ–π—Ç—ã —Å—é–¥–∞:
app.post(WEBHOOK_PATH, (req, res) => {
  bot.handleUpdate(req.body, res);
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, async () => {
  console.log(`üåê HTTP server on ${PORT}`);
  try { await bot.telegram.deleteWebhook(); } catch (e) { /* ignore */ }
  await bot.telegram.setWebhook(WEBHOOK_URL);
  console.log(`‚úÖ Webhook set: ${WEBHOOK_URL}`);
});
