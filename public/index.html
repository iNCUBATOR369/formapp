<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FormApp</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#6a6a6a;
      --primary:#0a84ff;
      --primary-contrast:#ffffff;
      --card:#f5f7fb;
      --radius:16px;
    }
    [data-theme="dark"]{
      --bg:#0e1116;
      --fg:#e6e6e6;
      --muted:#9aa4ad;
      --primary:#61a8ff;
      --primary-contrast:#0e1116;
      --card:#151a22;
    }
    html,body{
      padding:0;margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    .wrap{
      max-width:640px;
      margin:0 auto;
      padding:20px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
    }
    input,button{
      font-size:16px;
      border-radius:12px;
      border:none;
      outline:none;
    }
    input{
      width:100%;
      padding:12px 14px;
      background:#fff0;
      color:var(--fg);
      border:1px solid rgba(0,0,0,.08);
      background:rgba(0,0,0,.03);
    }
    button{
      padding:12px 16px;
      background:var(--primary);
      color:var(--primary-contrast);
      cursor:pointer;
    }
    .row{display:flex; gap:12px; align-items:center;}
    .row > * {flex:1;}
    .muted{color:var(--muted); font-size:14px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Welcome to FormApp üëã</h2>
    <p class="muted">Type any text below and press <b>Send to bot</b>. The bot will publish it in the chat.</p>

    <div class="card" style="margin-top:12px;">
      <input id="text" type="text" placeholder="This message came from the Mini App!" />
      <div class="row" style="margin-top:12px;">
        <button id="send">Send to bot</button>
        <button id="theme">Toggle theme</button>
      </div>
      <p class="muted" id="who" style="margin-top:12px;"></p>
    </div>
  </div>

  <script>
    const TG = window.Telegram.WebApp;

    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É —Ç–µ–ª–µ–≥—Ä–∞–º–∞
    const setTheme = () => {
      const dark = TG.colorScheme === 'dark' || TG.themeParams.bg_color === '#0e1116';
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
    };
    setTheme();
    TG.onEvent('themeChanged', setTheme);

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º user
    const user = TG.initDataUnsafe?.user;
    document.getElementById('who').textContent =
      user ? `User: ${user.first_name}${user.username ? ' (@'+user.username+')' : ''}` : '';

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç—É
    async function sendMessage() {
      const text = (document.getElementById('text').value || '').trim() || 'This message came from the Mini App!';
      try {
        const res = await fetch('/send', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text, initData: TG.initData })
        });

        if (!res.ok) throw new Error('Server responded with ' + res.status);

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–ø–∞–ø Telegram
        let closed = false;
        const onPopupClosed = () => { if (!closed){ closed = true; TG.offEvent('popupClosed', onPopupClosed); TG.close(); } };
        TG.onEvent('popupClosed', onPopupClosed);

        TG.showPopup(
          { title: 'Telegram', message: 'Sent!', buttons: [{ id: 'close', type: 'default', text: 'Close' }] },
          () => { onPopupClosed(); } // –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏—Å—ã–ª–∞—é—Ç callback —Å—Ä–∞–∑—É
        );

        // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–∏ callback, –Ω–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –¥–∞—Å—Ç
        setTimeout(onPopupClosed, 2000);

      } catch (e) {
        TG.showPopup({ title:'Error', message: String(e), buttons:[{id:'ok', type:'default', text:'OK'}] });
      }
    }

    document.getElementById('send').addEventListener('click', sendMessage);

    // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã –≤—Ä—É—á–Ω—É—é
    document.getElementById('theme').addEventListener('click', () => {
      const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', now);
    });

    // –≤–∞–∂–Ω–æ–µ: —Å–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ UI –≥–æ—Ç–æ–≤
    TG.ready();
  </script>
</body>
</html>
