<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FormApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #6a6a6a;
      --primary: #0a84ff;
      --primary-contrast: #ffffff;
      --card: #f5f7fb;
      --radius: 16px;
    }
    [data-theme="dark"] {
      --bg: #0e1621;
      --fg: #e6e6e6;
      --muted: #a0a7b4;
      --primary: #58a6ff;
      --primary-contrast: #0b141e;
      --card: #131f2e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 { margin: 0 0 12px; font-weight: 700; }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      margin: 14px 0;
    }
    label { display: block; margin-bottom: 6px; color: var(--muted); }
    input, button {
      font: inherit;
    }
    input {
      width: 100%;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fff;
      color: #111;
      border-radius: 10px;
      padding: 12px 14px;
    }
    [data-theme="dark"] input {
      background: #0f1a27;
      color: #e6e6e6;
      border-color: rgba(255,255,255,0.08);
    }
    .row { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .btn {
      padding: 12px 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: var(--primary);
      color: var(--primary-contrast);
      font-weight: 600;
    }
    .btn.secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    .muted { color: var(--muted); font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap" id="root">
    <h1>Welcome to FormApp 👋</h1>
    <p class="muted">Type any text and press <b>Send to bot</b>.</p>

    <div class="card">
      <label for="text">Text to send:</label>
      <input id="text" type="text" value="This message came from the Mini App!" />
      <div class="row">
        <button class="btn" id="sendBtn">Send to bot</button>
        <button class="btn secondary" id="toggleTheme">Toggle theme</button>
      </div>
      <p class="muted" id="userBox">User: …</p>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    function applyTheme() {
      const root = document.getElementById('root');
      const isDark = tg?.colorScheme === 'dark' ||
                     tg?.themeParams?.bg_color === '#0e1621' ||
                     tg?.themeParams?.bg_color === '#17212b';
      root.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }

    function initUserBox() {
      const u = tg?.initDataUnsafe?.user;
      const s = u ? `User: ${u.username ? '@'+u.username : (u.first_name || 'unknown')} (id:${u.id})`
                  : 'User: unknown';
      document.getElementById('userBox').textContent = s;
    }

    function sendToBot() {
      const val = document.getElementById('text').value || '';
      const payload = {
        type: 'form',
        text: val,
        ts: Date.now()
      };
      try {
        tg.HapticFeedback?.impactOccurred('light');
        tg.sendData(JSON.stringify(payload)); // <-- важная строка: отправка в бота
      } catch (e) {
        alert('Telegram WebApp is not available: ' + (e?.message || e));
      }
    }

    function toggleTheme() {
      const root = document.getElementById('root');
      const cur = root.getAttribute('data-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
    }

    // Инициализация
    (function main() {
      try { tg?.expand(); } catch (_) {}
      try { tg?.ready(); } catch (_) {}
      applyTheme();
      initUserBox();

      document.getElementById('sendBtn').addEventListener('click', sendToBot);
      document.getElementById('toggleTheme').addEventListener('click', toggleTheme);

      // Реакция на смену темы из Telegram
      tg?.onEvent?.('themeChanged', applyTheme);
    })();
  </script>
</body>
</html>
