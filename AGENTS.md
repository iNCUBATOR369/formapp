# –¢–ó –¥–ª—è Codex: FormApp ‚Äî Telegram Mini App-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

## 0) –†–æ–ª—å Codex –∏ –æ–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–¥–∞—á–∏

* Codex –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ **–≤–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫**.
* –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞: –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–≥–æ—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Ü–µ–ª–∏–∫–æ–º** (–Ω–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã), –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —á–µ–∫-–ª–∏—Å—Ç—ã –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
* –ö–æ–¥ ‚Äî —Å—Ä–∞–∑—É —Ä–∞–±–æ—á–∏–π, –±–µ–∑ ‚ÄúTODO‚Äù.
* –°—Ç–µ–∫ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –Ω–∏–∂–µ. –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ, —Å–Ω–∞—á–∞–ª–∞ –¥–∞—Ç—å –¥–∏—Ñ—Ñ-–≤–∞—Ä–∏–∞–Ω—Ç ¬´–¢–µ–∫—É—â–µ–µ ‚Üí –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ¬ª –∏ –æ–±—ä—è—Å–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é.

---

## 1) –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞

**FormApp** ‚Äî Telegram Mini App (TWA) + –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π:

1. –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ —á–∞—Ç–∞ –∫–Ω–æ–ø–∫–æ–π **Web App** (–º–µ–Ω—é –±–æ—Ç–∞) –∏/–∏–ª–∏ –∫–Ω–æ–ø–∫–æ–π **Open FormApp** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–Ω–æ–ø–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏),
2. –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É (—Ç–µ–∫—Å—Ç ‚Üí –∫–Ω–æ–ø–∫–∞ ‚ÄúSend to bot‚Äù),
3. –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —á–∞—Ç, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ,
4. —É–≤–∞–∂–∞–µ—Ç —Ç–µ–º—É (light/dark) Telegram,
5. –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–±–µ–∑ ¬´–≤—Ç–æ—Ä—ã—Ö¬ª –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –ø–æ–ø–∞–ø–æ–≤).

**–î–∞–ª—å—à–µ (—Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–ª–∏–∑—ã)**: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –º–∏–Ω–∏-–∞–ø–ø –≤ **–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ–æ—Ä–º**: —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–æ—Ä–º—ã (–ø–æ–ª—è, –ø—Ä–∞–≤–∏–ª–∞), –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏—Ö –∏ —Å–æ–±–∏—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç—ã, —Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –≤ –ë–î, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ —á–∞—Ç –∏ –≤ –∞–¥–º–∏–Ω–∫—É.

---

## 2) –¢–µ–∫—É—â–µ–µ —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å)

* –î–µ–ø–ª–æ–π –Ω–∞ **Render** –∫–∞–∫ Web Service (Node).
* –°–µ—Ä–≤–µ—Ä ‚Äî Node.js + Express + Telegraf.
* –í–µ–±-—Ö—É–∫–∞ –±–æ—Ç–∞: `POST /tg`.
* –°—Ç–∞—Ç–∏–∫–∞ –º–∏–Ω–∏-–∞–ø–∞ ‚Äî –∏–∑ `/public`.
* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  * `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞,
  * `PUBLIC_URL` ‚Äî –∫–æ—Ä–µ–Ω—å —Ö–æ—Å—Ç–∞ Render –±–µ–∑ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å–ª–µ—à–∞, –Ω–∞–ø—Ä. `https://formapp-xvb0.onrender.com`.
* –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞: `/start` (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è Web App), `/ping` ‚Üí `pong`.
* **–†–∞–±–æ—Ç–∞–µ—Ç**:
  * –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ –æ–±–µ–∏–º –∫–Ω–æ–ø–∫–∞–º,
  * –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –º–∏–Ω–∏-–∞–ø–∞,
  * –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ (–±–µ–∑ ¬´–∑–∞–ª–∏–ø–∞—é—â–∏—Ö¬ª –º–æ–¥–∞–ª–æ–∫),
  * –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Render.
* **–í–∞–∂–Ω–æ**: –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–µ–¥–∏–Ω—ã–º** –∏ –Ω–µ –ª–æ–º–∞—Ç—å —É–∂–µ —Ä–∞–±–æ—á–∏–µ –º–µ—Ö–∞–Ω–∏–∫–∏.

---

## 3) –¶–µ–ª—å –±–ª–∏–∂–∞–π—à–µ–≥–æ —Ä–µ–ª–∏–∑–∞ (MVP-—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è)

### 3.1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É

* –°—Ç–µ–∫: **Node 18+**, **Express**, **Telegraf 4**, **CommonJS** (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ warning‚Äô–æ–≤ –ø—Ä–æ ESM –≤ Render).
* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:

```
/package.json
/server.js
/.render-build.sh            (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Å–∫—Ä–∏–ø—Ç)
/public
  /index.html
  /app.js
  /styles.css
```

* **package.json** (–ø—Ä–∏–º–µ—Ä):

```json
{
  "name": "formapp",
  "version": "1.0.0",
  "private": true,
  "main": "server.js",
  "type": "commonjs",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.19.2",
    "telegraf": "^4.16.3",
    "body-parser": "^1.20.2",
    "morgan": "^1.10.0",
    "helmet": "^7.1.0"
  }
}
```

* **server.js** ‚Äî –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π:
  1. –ü–æ–¥–Ω–∏–º–∞–µ—Ç Express, —Ä–∞–∑–¥–∞—ë—Ç `/public` –∫–∞–∫ —Å—Ç–∞—Ç–∏–∫—É.
  2. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç Telegraf, —Å—Ç–∞–≤–∏—Ç –≤–µ–±-—Ö—É–∫ –Ω–∞ `POST /tg` ‚Üí `bot.webhookCallback('/tg')`.
  3. –†–µ–∞–ª–∏–∑—É–µ—Ç `GET /healthz` (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ok:true}`).
  4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã `/start` –∏ `/ping`.
  5. –ò–º–µ–µ—Ç REST-—ç–Ω–¥–ø–æ–π–Ω—Ç `POST /api/send`:
     * –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `{ text, initData }`,
     * **–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç `initData`** –ø–æ HMAC (—Å–º. ‚ÄúSecurity‚Äù –Ω–∏–∂–µ),
     * –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `chat_id` (–∏–∑ `initData` ‚Üí `chat.id` –ª–∏–±–æ, –µ—Å–ª–∏ –Ω–µ—Ç, `user.id`),
     * –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `text` –≤ —á–∞—Ç —á–µ—Ä–µ–∑ `bot.telegram.sendMessage(chat_id, ...)`,
     * –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ ok: true }` –∏–ª–∏ `{ ok:false, error:... }`.
  6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (morgan) –∏ –∑–∞—â–∏—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (helmet).

* **–°—Ç–∞—Ä—Ç-–∫–æ–º–∞–Ω–¥–∞ Render**: `node server.js`.
* **Build-–∫–æ–º–∞–Ω–¥–∞**: `npm install`.
* **–í–µ–±-—Ö—É–∫** –Ω–∞ —Å—Ç–∞—Ä—Ç–µ ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ: `await bot.telegram.setWebhook(PUBLIC_URL + '/tg')`.

> **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ù–∏–∫–∞–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö axios/fetch –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî —Ç–æ–ª—å–∫–æ `bot.telegram.sendMessage` –∏ Express.

### 3.2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É (`/public`)

* **index.html**:
  * –ø–æ–¥–∫–ª—é—á–∞–µ—Ç `<script src="https://telegram.org/js/telegram-web-app.js"></script>`,
  * –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞: –ø–æ–ª–µ –≤–≤–æ–¥–∞, `Send to bot`, –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (–º–µ–Ω—è–µ—Ç CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ),
  * –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Ç–æ—Å—Ç—ã/–∞–ª–µ—Ä—Ç—ã ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–µ Telegram `showAlert` / `showPopup` (–±–µ–∑ ‚Äú–≤—Ç–æ—Ä–æ–≥–æ‚Äù –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞).
* **app.js**:
  * `Telegram.WebApp.ready(); Telegram.WebApp.expand();`
  * —á–∏—Ç–∞–µ–º `initDataUnsafe` –∏ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –µ–≥–æ —Å—Ç—Ä–æ–∫–æ–π `initData` –ø—Ä–∏ POST `/api/send`,
  * –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:
    * –ø–æ–∫–∞–∑–∞—Ç—å `showAlert('Sent!')`,
    * **–∏ –∑–∞—Ç–µ–º** –≤—ã–∑–≤–∞—Ç—å `Telegram.WebApp.close();` (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–≤–µ—Ä–ª–µ–µ–≤),
    * –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî `showAlert('Error: ...')`, **–Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å**.
* **styles.css**:
  * –¥–≤–µ —Ç–µ–º—ã —á–µ—Ä–µ–∑ `:root` –∏ `[data-theme="dark"]` (–æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ `Telegram.WebApp.colorScheme`),
  * –±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö UI-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤.

### 3.3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* **–ü—Ä–æ–≤–µ—Ä–∫–∞ initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `server.js` —Ñ—É–Ω–∫—Ü–∏—é –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ [–¥–æ–∫–∞–º Telegram](https://core.telegram.org/bots/webapps#validating-data-received-via-the-web-app).
  * HMAC-SHA256 —Å –∫–ª—é—á–æ–º `hash = HMAC_SHA256(data_check_string, secret_key)`, –≥–¥–µ `secret_key = HMAC_SHA256("WebAppData", BOT_TOKEN)`.
  * –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º `initData` ‚Üí 403.

### 3.4. UX-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–≤–∞–∂–Ω–æ)

* **–ï–¥–∏–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è**: –ø–æ—Å–ª–µ `ok` –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ–¥–∏–Ω –Ω–µ–±–æ–ª—å—à–æ–π alert/—Ç–æ—Å—Ç –∏ **–∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ**. –ù–∏–∫–∞–∫–∏—Ö –≤—Ç–æ—Ä–∏—á–Ω—ã—Ö –æ–≤–µ—Ä–ª–µ–µ–≤ ‚ÄúClose‚Äù, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å.
* –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏:
  * —á–µ—Ä–µ–∑ **–∫–Ω–æ–ø–∫—É Web App** –∏–∑ –º–µ–Ω—é –±–æ—Ç–∞,
  * —á–µ—Ä–µ–∑ **–∫–Ω–æ–ø–∫—É Open FormApp** (inline-–∫–Ω–æ–ø–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏).

### 3.5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è BotFather

* –ö–æ–º–∞–Ω–¥—ã:
  * `/start` ‚Äî Open app,
  * `/ping` ‚Äî pong,
  * `/help` ‚Äî –∫—Ä–∞—Ç–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞.
* **Menu Button (Web App URL)** = `${PUBLIC_URL}` (–±–µ–∑ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å–ª–µ—à–∞).
* **Domain** ‚Äî –¥–æ–º–µ–Ω Render (—É–∫–∞–∑–∞–Ω –≤—ã—à–µ).

### 3.6. –ü—Ä–∏—ë–º–∫–∞ (—á–µ–∫-–ª–∏—Å—Ç)

1. `/healthz` ‚Üí 200, `{ok:true}`.
2. `GET https://api.telegram.org/bot<token>/getWebhookInfo` ‚Üí `{"url": "<PUBLIC_URL>/tg", "pending_update_count": ...}`.
3. `/start` ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫–∞ **Web App**.
4. `/ping` ‚Üí `pong`.
5. –û—Ç–∫—Ä—ã—Ç—å Web App (–º–µ–Ω—é) ‚Üí –≤–≤–µ—Å—Ç–∏ ‚ÄúHello from menu‚Äù ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–º –∂–µ —á–∞—Ç–µ; –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
6. –ù–∞–∂–∞—Ç—å inline-–∫–Ω–æ–ø–∫—É **Open FormApp** –∏–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ‚Üí –≤–≤–µ—Å—Ç–∏ ‚ÄúHello from inline‚Äù ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç; –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è; —Ç–µ–º–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Telegram; –ª–∏—à–Ω–∏—Ö –æ–∫–æ–Ω –Ω–µ—Ç.
7. –õ–æ–≥–∏ Render –±–µ–∑ –æ—à–∏–±–æ–∫ (–Ω–µ—Ç ESM warning, axios not found –∏ —Ç.–ø.).

---

## 4) –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ–æ—Ä–º

### 4.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

* –î–æ–±–∞–≤–∏—Ç—å **PostgreSQL** (Render Postgres).
* ORM: **Prisma**.
* –°—É—â–Ω–æ—Å—Ç–∏:
  * `User(id, tg_id, username, created_at)`,
  * `Form(id, owner_id, title, schema_json, is_published, created_at, updated_at)`,
  * `Submission(id, form_id, tg_user_id, chat_id, payload_json, created_at)`.
* `schema_json` ‚Äî JSON-–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π (text, select, checkbox, file\*).
* TWA –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ä–º—É `GET /api/forms/:id` ‚Üí –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –ø–æ–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏.
* `POST /api/forms/:id/submit` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç Submission + –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤ —á–∞—Ç.

### 4.2. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–º–∏–∫—Ä–æ-MVP)

* `/admin` (–±–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É –≤ .env, –ø–æ–∑–∂–µ ‚Äî Telegram OAuth).
* CRUD —Ñ–æ—Ä–º:
  * —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É (title + schema_json),
  * –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é,
  * —Å–ø–∏—Å–æ–∫ —Å–∞–±–º–∏—à–Ω–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏/—ç–∫—Å–ø–æ—Ä—Ç–æ–º `.csv`.

### 4.3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

* –í TWA –≤–∞–ª–∏–¥–∞—Ü–∏—è initData (–∫–∞–∫ –≤—ã—à–µ).
* –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π **ADMIN_TOKEN** –≤ .env; –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ Telegram OAuth + role-based access.

### 4.4. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞/–º–µ—Ç—Ä–∏–∫–∏

* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ª–æ–≥–∏ + –º–µ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (request-id).
* Health-checks, –∞–ª–µ—Ä—Ç—ã Render (–µ—Å–ª–∏ –µ—Å—Ç—å).

---

## 5) –§–∞–π–ª–æ–≤—ã–π —Å–∫–µ–ª–µ—Ç (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å, —á—Ç–æ–±—ã Codex –∑–Ω–∞–ª —Ü–µ–ª–µ–≤—É—é —Ñ–æ—Ä–º—É)

### 5.1. `server.js` (–∫–æ–Ω—Ç—É—Ä—ã)

```js
const express = require('express');
const path = require('path');
const morgan = require('morgan');
const helmet = require('helmet');
const { Telegraf } = require('telegraf');
const crypto = require('crypto');

const BOT_TOKEN = process.env.BOT_TOKEN;
const PUBLIC_URL = process.env.PUBLIC_URL;

if (!BOT_TOKEN || !PUBLIC_URL) {
  console.error('BOT_TOKEN or PUBLIC_URL is missing');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);
const app = express();

app.use(helmet());
app.use(morgan('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// -------- Telegram bot
bot.start(async (ctx) => {
  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è inline-–æ—Ç–∫—Ä—ã—Ç–∏—è
  await ctx.reply('Welcome to FormApp üëã\nTap the button below to open the mini app.', {
    reply_markup: {
      inline_keyboard: [[{ text: 'Open FormApp', web_app: { url: PUBLIC_URL } }]],
    },
  });
});
bot.command('ping', (ctx) => ctx.reply('pong'));

// –í–µ–±—Ö—É–∫
app.use('/tg', bot.webhookCallback('/tg'));

// -------- REST API
app.get('/healthz', (_, res) => res.json({ ok: true }));

// –í–∞–ª–∏–¥–∞—Ü–∏—è initData –∏–∑ Telegram WebApp
function validateInitData(initData) {
  // https://core.telegram.org/bots/webapps#validating-data-received-via-the-web-app
  try {
    const urlParams = new URLSearchParams(initData);
    const hash = urlParams.get('hash');
    urlParams.delete('hash');

    const dataCheckString = Array.from(urlParams.entries())
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([k, v]) => `${k}=${v}`)
      .join('\n');

    const secret = crypto.createHmac('sha256', 'WebAppData').update(BOT_TOKEN).digest();
    const calcHash = crypto.createHmac('sha256', secret).update(dataCheckString).digest('hex');

    return calcHash === hash;
  } catch {
    return false;
  }
}

app.post('/api/send', async (req, res) => {
  const { text, initData } = req.body || {};
  if (!text || !initData) return res.status(400).json({ ok: false, error: 'Bad payload' });
  if (!validateInitData(initData)) return res.status(403).json({ ok: false, error: 'Invalid initData' });

  const unsafe = Object.fromEntries(new URLSearchParams(initData));
  const chat = unsafe.chat ? JSON.parse(unsafe.chat) : null;
  const user = unsafe.user ? JSON.parse(unsafe.user) : null;

  const chatId = (chat && chat.id) || (user && user.id);
  if (!chatId) return res.status(400).json({ ok: false, error: 'No chat_id' });

  try {
    await bot.telegram.sendMessage(chatId, `Got it: ${text}`);
    res.json({ ok: true });
  } catch (e) {
    console.error(e);
    res.status(500).json({ ok: false, error: 'Send failed' });
  }
});

// -------- Static
app.use(express.static(path.join(__dirname, 'public')));

// -------- Start
async function start() {
  await bot.telegram.setWebhook(`${PUBLIC_URL}/tg`);
  const port = process.env.PORT || 10000;
  app.listen(port, () => console.log('HTTP server on', port));
}
start().catch((e) => {
  console.error(e);
  process.exit(1);
});
```

### 5.2. `/public/index.html` (–∫–æ–Ω—Ç—É—Ä—ã)

```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FormApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="card">
    <h1>Welcome to FormApp üëã</h1>
    <input id="msg" placeholder="This message came from the Mini App!" />
    <div class="row">
      <button id="send">Send to bot</button>
      <button id="toggle">Toggle theme</button>
    </div>
    <p id="user"></p>
  </main>

  <script src="/app.js"></script>
</body>
</html>
```

### 5.3. `/public/app.js` (–∫–æ–Ω—Ç—É—Ä—ã)

```js
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const msg = document.getElementById('msg');
const btn = document.getElementById('send');
const toggle = document.getElementById('toggle');
const userEl = document.getElementById('user');

const u = tg.initDataUnsafe?.user;
userEl.textContent = u ? `User: ${u.username ?? u.id}` : '';

function applyTheme() {
  document.documentElement.dataset.theme = tg.colorScheme === 'dark' ? 'dark' : 'light';
}
applyTheme();

toggle.onclick = () => {
  const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
};

btn.onclick = async () => {
  const text = msg.value.trim() || 'This message came from the Mini App!';
  try {
    const r = await fetch('/api/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, initData: tg.initData })
    });
    const data = await r.json();
    if (!data.ok) throw new Error(data.error || 'unknown');
    await tg.showAlert('Sent!');
    tg.close(); // –µ–¥–∏–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è
  } catch (e) {
    await tg.showAlert('Error: ' + e.message);
  }
};
```

### 5.4. `/public/styles.css` (–∫–æ–Ω—Ç—É—Ä—ã)

```css
:root {
  --bg: #ffffff;
  --fg: #111111;
  --primary: #0a84ff;
  --card: #f5f7fb;
  --radius: 14px;
}
:root[data-theme="dark"] {
  --bg: #0e0f13;
  --fg: #ffffff;
  --primary: #56b2ff;
  --card: #171a21;
}

* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

main.card {
  max-width: 560px;
  margin: 40px auto;
  background: var(--card);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
}

input { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(0,0,0,.12); background: #fff; }
.row { display: flex; gap: 12px; margin-top: 12px; }
button { flex: 1; padding: 12px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-weight: 600; cursor: pointer; }
```

---

## 6) –ü–ª–∞–Ω —Ä–µ–ª–∏–∑–æ–≤ / –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

1. **–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è MVP (—Å–ø—Ä–∏–Ω—Ç 1)**
   * –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—á–∏–π –∫–æ–¥ –ø–æ —Å–∫–µ–ª–µ—Ç—É –≤—ã—à–µ.
   * –ü—Ä–æ–≤–µ—Ä–∫–∞ initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
   * –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è UX –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞.
   * –ß–∏—Å—Ç—ã–µ –ª–æ–≥–∏ –Ω–∞ Render, `/start` –∏ `/ping` —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.
   * –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∫–∏ –ø—Ä–æ–π–¥–µ–Ω.
2. **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ–æ—Ä–º (—Å–ø—Ä–∏–Ω—Ç 2‚Äì3)**
   * –ü–æ–¥–∫–ª—é—á–∏—Ç—å Postgres (Render), Prisma.
   * CRUD —Ñ–æ—Ä–º + –ø—É–±–ª–∏–∫–∞—Ü–∏—è.
   * –†–µ–Ω–¥–µ—Ä —Ñ–æ—Ä–º—ã –ø–æ `schema_json` –≤ TWA.
   * `POST /submit` ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç.
   * –ü—Ä–æ—Å—Ç–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å `/admin` (–ø–æ —Ç–æ–∫–µ–Ω—É).
3. **–£–ª—É—á—à–µ–Ω–∏—è (—Å–ø—Ä–∏–Ω—Ç 4+)**
   * Telegram OAuth –¥–ª—è –∞–¥–º–∏–Ω–∫–∏.
   * –ü–æ–ª—è: —Ñ–∞–π–ª—ã/–º–µ–¥–∏–∞, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è, –ø–æ–¥–ø–∏—Å—å, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã.
   * –í–µ–±-—Ö—É–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (CRM/Sheets).
   * –ú—É–ª—å—Ç–∏-—è–∑—ã–∫, A/B, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.

---

## 7) –î–µ–ø–ª–æ–π (Render) ‚Äî –∫—Ä–∞—Ç–∫–∞—è –ø–∞–º—è—Ç–∫–∞

* **Start Command**: `node server.js`
* **Build Command**: `npm install`
* **Env**:
  * `BOT_TOKEN=...`
  * `PUBLIC_URL=https://formapp-xvb0.onrender.com` *(–±–µ–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ `/`)*
* –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
  * `/healthz`,
  * `getWebhookInfo` ‚Üí `.../tg`.

---

## 8) –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å Codex –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

1. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å **–ø–æ–ª–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π** –ø–æ —Å–∫–µ–ª–µ—Ç—É –≤—ã—à–µ (–≤—Å–µ —Ñ–∞–π–ª—ã —Ü–µ–ª–∏–∫–æ–º).
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ **–Ω–µ—Ç** ESM-warning –Ω–∞ Render, `/start` –∏ `/ping` —Ä–∞–±–æ—Ç–∞—é—Ç.
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é initData.
4. –î–æ–±–∏—Ç—å—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –∏–∑ **–æ–±–µ–∏—Ö** —Ç–æ—á–µ–∫ –≤—Ö–æ–¥–∞ (Web App menu + Open FormApp).
5. –í—ã–¥–∞—Ç—å –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á–µ–∫-–ª–∏—Å—Ç –∏–∑ 3.6).

